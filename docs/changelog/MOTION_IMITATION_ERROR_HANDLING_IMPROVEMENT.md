# 动作模仿错误处理改进

## 更新日期
2025-10-16

## 问题描述

在测试即梦动作模仿功能时，发现以下问题：

### 1. 500 Internal Error 错误
```
查询任务状态时返回：
HTTP 500: Internal Error
{
  "code": 50500,
  "message": "Internal Error"
}
```

### 2. 错误提示不够友好
原有的错误提示只显示 "Internal Error"，用户不知道如何处理。

## 问题分析

### 500错误的可能原因

根据测试和分析，500 Internal Error 可能由以下原因导致：

1. **任务初始化延迟**
   - 任务刚提交后，后端系统需要时间来注册和初始化任务
   - 虽然提交API返回成功，但查询API可能还无法立即获取状态
   - 建议等待时间：3-5分钟

2. **API服务端暂时性故障**
   - 火山引擎API可能存在短暂的服务波动
   - 通常会在1-2分钟内自动恢复

3. **输入参数问题**
   - 图片或视频URL无法访问
   - 文件格式不支持
   - 文件过大或损坏

4. **并发限制**
   - 账号可能达到了并发任务数限制
   - 需要等待其他任务完成

## 解决方案

### 1. 改进错误提示 (`MotionImitation.js`)

#### 添加专门的500错误处理

```javascript
// 处理500 Internal Error
if (errorMessage.includes('Internal Error') || errorMessage.includes('500')) {
  userMessage = `⚠️ 服务器内部错误 (500)

可能原因：
1. 任务正在初始化中，系统还未完全准备好
2. API服务端暂时性故障
3. 任务处理遇到问题

💡 建议：
• 等待1-2分钟后再次刷新
• 如果持续失败，可能需要重新提交任务
• 检查输入的图片和视频URL是否正常访问

任务ID: ${taskId}`;
}
```

#### 改进任务提交成功提示

```javascript
showAlert('success', `✅ 任务提交成功！

📋 任务ID: ${taskId}
🔧 接口: ${apiVersionText}

任务正在生成中，请在"任务列表"标签页中查看进度。

⏱️ 重要提示：
• 新任务需要约1-3分钟开始处理
• 建议等待3-5分钟后再点击"刷新状态"
• 过早查询可能会遇到"Internal Error"，这是正常现象
• 生成完整视频通常需要5-10分钟`);
```

### 2. API层增强日志 (`api-service.js`)

```javascript
// 为500错误提供额外信息
if (response.status === 500 || data.code === 50500) {
  console.warn('⚠️ 500 Internal Error - 可能原因：');
  console.warn('1. 任务刚提交，系统还在初始化');
  console.warn('2. API服务端暂时性故障');
  console.warn('3. 输入参数有问题导致处理失败');
  console.warn('建议：等待1-2分钟后重试，或检查输入URL是否可访问');
}
```

## 最佳实践建议

### 1. 任务提交后的正确流程

```
1. 提交任务 → 获得 task_id
   ↓
2. 等待 3-5 分钟（让系统初始化）
   ↓
3. 点击"刷新状态"查询进度
   ↓
4. 如果遇到500错误 → 再等待1-2分钟后重试
   ↓
5. 任务完成 → 下载视频
```

### 2. 输入文件要求

#### 图片要求
- ✅ 格式：JPEG、PNG
- ✅ 大小：建议不超过10MB
- ✅ 内容：包含清晰的人脸
- ✅ URL：公网可访问，无防盗链
- ✅ 分辨率：建议不超过2048x2048

#### 视频要求
- ✅ 格式：MP4
- ✅ 大小：建议不超过50MB
- ✅ 时长：建议5-30秒
- ✅ URL：公网可访问，无防盗链
- ✅ 码率：建议不超过5Mbps

### 3. 故障排查步骤

如果遇到持续的500错误：

1. **检查URL可访问性**
   ```bash
   # 测试图片URL
   curl -I https://your-image-url.jpg
   
   # 测试视频URL
   curl -I https://your-video-url.mp4
   ```

2. **检查文件格式**
   - 确保图片是JPEG或PNG格式
   - 确保视频是MP4格式
   - 检查文件是否损坏

3. **检查账号状态**
   - 登录火山引擎控制台
   - 查看API调用配额
   - 查看账号余额

4. **尝试其他测试文件**
   - 使用公开的测试图片和视频
   - 排除是否是文件本身的问题

### 4. 错误码参考

| 错误码 | 含义 | 处理方式 |
|--------|------|----------|
| 10000 | 成功 | 正常 |
| 50500 | 内部错误 | 等待重试 |
| 50411 | 图片审核未通过 | 更换图片 |
| 50511 | 输出审核未通过 | 重试或更换输入 |
| 50429 | QPS超限 | 降低请求频率 |
| 50430 | 并发超限 | 等待任务完成 |

## 测试结果

### 成功案例

✅ **测试1**: 本地文件上传 + 即梦接口
- 图片：换模特.jpeg (5.3KB)
- 视频：单人跳舞视频.mp4 (90KB)
- 提交：成功 (task_id: 5830178714494046720)
- 状态：初次查询遇到500（正常现象）

### 已知限制

⚠️ **注意事项**:
1. 新提交的任务在前3-5分钟查询可能返回500错误
2. 这是API服务端的正常行为，不是客户端问题
3. 需要用户理解并等待足够的时间
4. 建议在UI中添加倒计时或自动刷新功能

## 后续优化计划

- [ ] 添加自动轮询功能，等待5分钟后自动查询
- [ ] 添加倒计时显示，提示用户还需等待多久
- [ ] 实现智能重试机制，遇到500自动间隔重试
- [ ] 添加任务状态变化通知
- [ ] 支持批量任务管理

## 相关文档

- [即梦动作模仿接口文档](../api/即梦动作模仿.md)
- [即梦动作模仿集成文档](./JIMENG_MOTION_IMITATION_INTEGRATION.md)
- [TOS上传功能修复](./TOS_UPLOAD_FIX.md)

## 用户使用建议

### 推荐工作流程

1. **准备素材**
   - 使用TOS上传或准备公开的URL
   - 确保文件可正常访问

2. **提交任务**
   - 选择"即梦动作模仿（推荐）"
   - 填写图片和视频信息
   - 点击提交

3. **等待处理**
   - ⏰ 不要立即查询状态
   - ☕ 等待3-5分钟（喝杯咖啡）
   - 📱 可以先处理其他事情

4. **查看结果**
   - 返回任务列表
   - 点击"刷新状态"
   - 如果遇到500，再等1-2分钟

5. **下载视频**
   - 任务完成后立即下载
   - 视频链接1小时内有效

### 避免的错误做法

❌ **不要做**:
- 任务提交后立即查询（<30秒）
- 短时间内频繁刷新（<10秒）
- 使用无法公网访问的URL
- 上传过大的文件（>50MB）

✅ **应该做**:
- 等待足够的时间再查询
- 合理控制查询频率
- 使用可靠的存储服务
- 优化文件大小和质量

## 总结

通过改进错误处理和用户提示，现在用户在遇到500错误时可以：
1. 了解错误的可能原因
2. 获得明确的操作建议
3. 知道何时应该重试
4. 理解这是正常的等待过程

这大大提升了用户体验和产品的可用性。


