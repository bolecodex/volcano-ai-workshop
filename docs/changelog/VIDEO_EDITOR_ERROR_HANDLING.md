# 视频编辑功能错误处理优化

## 日期
2025-10-18

## 问题描述

在使用视频编辑功能时，用户可能会遇到以下情况：

1. **视频上传成功** ✅
2. **任务提交成功** ✅  
3. **立即查询任务状态时遇到服务器内部错误** ❌

### 典型错误信息

```
HTTP 500 - Internal Server Error
Code: 50501
Message: Internal RPC Error: run comfyui pipeline error
Details: could not be loaded with cv
```

## 根本原因

这是视频编辑服务的正常工作流程特征，而非真正的错误：

1. **异步处理机制**：视频编辑任务提交后，后端服务需要时间来：
   - 下载并验证输入视频
   - 初始化处理管道
   - 应用编辑指令
   - 生成输出视频

2. **处理延迟**：
   - 任务刚提交时，后端可能还在初始化
   - 立即查询会遇到临时的内部错误
   - 这是因为视频还未完全加载到处理系统中

3. **时间窗口**：
   - 正常的处理时间：1-3 分钟
   - 初始化阶段（前 10-30 秒）：可能返回内部错误
   - 处理阶段：返回 `generating` 状态
   - 完成阶段：返回 `done` 状态和视频 URL

## 解决方案

### 1. 优化后端错误处理

在 `api-service.js` 中添加特殊处理逻辑：

```javascript
if (data.code === 50501 || data.code === 50500) {
  console.warn('⚠️ Server Internal Error - Task may still be processing');
  
  // 返回特殊状态而不是抛出错误
  return {
    success: true,
    data: {
      status: 'generating',  // 标记为处理中
      message: '任务处理中，请稍后再试',
      server_error: true,
      error_code: data.code
    }
  };
}
```

**优势**：
- 将临时的服务器错误转换为"处理中"状态
- 避免用户误以为任务失败
- 提供明确的指导信息

### 2. 优化前端用户提示

在 `VideoEditor.js` 中：

```javascript
// 处理服务器内部错误
if (result.data.server_error) {
  showAlert('warning', `⚠️ ${result.data.message}`);
  return result.data;
}
```

**改进**：
- 使用警告（warning）而非错误（danger）级别
- 提供友好的说明文字
- 引导用户稍后重试

### 3. 增强使用说明

在界面中添加处理时间说明：

```
⏱️ 处理时间：
- 任务提交后需要等待1-3分钟进行处理
- 如果查询时显示"任务处理中"，请等待后再次刷新
- 建议每隔30秒点击一次"刷新状态"按钮
- 处理失败可能是视频格式不支持，建议转换为标准MP4格式
```

## 使用建议

### 正确的工作流程

1. **上传视频** → 等待上传完成
2. **输入指令** → 填写编辑要求
3. **提交任务** → 获得任务 ID
4. **等待 30 秒** → 给服务器处理时间
5. **首次查询** → 可能显示"处理中"
6. **继续等待** → 每隔 30 秒刷新一次
7. **任务完成** → 下载结果视频

### 错误情况处理

#### 情况 1: 持续显示"任务处理中"

**可能原因**：
- 视频较大，处理时间较长
- 编辑指令复杂，需要更多计算

**解决方法**：
- 继续等待，每分钟刷新一次
- 等待 5-10 分钟后仍无结果，可尝试重新提交

#### 情况 2: 多次查询都返回内部错误

**可能原因**：
- 视频格式不受支持
- 视频 URL 无法访问
- 视频内容有问题

**解决方法**：
1. 检查视频格式（推荐标准 MP4）
2. 尝试转换视频编码（H.264 编码）
3. 减小视频大小和时长
4. 简化编辑指令

#### 情况 3: 任务失败

**可能原因**：
- 视频质量问题
- 指令无法执行
- 服务器资源限制

**解决方法**：
- 使用高质量的输入视频
- 优化编辑指令描述
- 分步骤进行复杂编辑

## 技术细节

### 错误码说明

| 错误码 | 含义 | 处理方式 |
|--------|------|----------|
| 10000 | 成功 | 正常处理 |
| 50500 | 内部错误 | 标记为处理中，等待重试 |
| 50501 | 内部 RPC 错误 | 标记为处理中，等待重试 |
| 50411 | 输入审核未通过 | 提示用户修改输入 |
| 50429 | QPS 超限 | 等待后重试 |
| 50430 | 并发超限 | 等待后重试 |

### 状态流转

```
提交 → in_queue (排队中)
     ↓
     generating (处理中)
     ↓
     ↙           ↘
  done (完成)   error (失败)
```

**注意**：在 `in_queue` 到 `generating` 的转换期间，可能会临时返回内部错误（50501）。这是正常现象，表示任务正在被调度。

## 最佳实践

### 1. 视频准备

- ✅ 使用标准 MP4 格式（H.264 编码）
- ✅ 控制文件大小 ≤ 15MB
- ✅ 控制时长 ≤ 10 秒
- ✅ 使用清晰的视频源
- ✅ 确保视频可正常播放

### 2. 任务提交

- ✅ 使用简洁明确的编辑指令
- ✅ 单次只使用一个编辑目标
- ✅ 提交后记录任务 ID
- ✅ 不要立即查询，等待 30 秒

### 3. 状态查询

- ✅ 首次查询前等待至少 30 秒
- ✅ 查询间隔设为 30-60 秒
- ✅ 最多等待 5-10 分钟
- ✅ 遇到错误时查看详细信息
- ✅ 必要时重新提交任务

### 4. 错误处理

- ✅ 区分临时错误和永久错误
- ✅ 临时错误：等待后重试
- ✅ 永久错误：检查输入并修改
- ✅ 保存错误信息用于排查
- ✅ 联系技术支持时提供任务 ID

## 性能优化建议

### 减少等待时间

1. **优化视频**
   - 使用较低分辨率（720P 或以下）
   - 压缩文件大小
   - 剪辑到必要时长

2. **简化指令**
   - 使用单一明确的编辑目标
   - 避免过于复杂的描述
   - 分步骤进行复杂编辑

3. **避免高峰期**
   - 高峰期可能排队时间较长
   - 建议非高峰时段使用

## 故障排查清单

遇到问题时，按以下顺序检查：

- [ ] 视频是否成功上传？
- [ ] 任务 ID 是否正确？
- [ ] 是否等待了足够的时间（≥30 秒）？
- [ ] 视频格式是否为标准 MP4？
- [ ] 视频大小是否 ≤ 15MB？
- [ ] 视频时长是否 ≤ 10 秒？
- [ ] 编辑指令是否清晰明确？
- [ ] 网络连接是否正常？
- [ ] AccessKey 配置是否正确？
- [ ] TOS 配置是否正确？

## 常见问题 FAQ

### Q: 为什么刚提交就查询会报错？

A: 这是正常现象。视频编辑服务需要时间来初始化任务。建议提交后等待至少 30 秒再进行首次查询。

### Q: 一直显示"任务处理中"怎么办？

A: 继续等待。正常的处理时间是 1-3 分钟。如果超过 10 分钟仍未完成，可能需要检查视频格式或重新提交。

### Q: 如何知道任务是真的失败了？

A: 真正的失败会返回明确的错误消息，如"审核未通过"、"格式不支持"等。如果只是返回内部错误，通常表示还在处理中。

### Q: 可以批量提交多个任务吗？

A: 可以，但注意并发限制为 1。建议等待前一个任务完成后再提交新任务，以获得更好的处理速度。

### Q: 结果视频的链接有效期多长？

A: 结果视频链接有效期为 1 小时。建议任务完成后立即下载保存。

## 总结

视频编辑功能的"内部错误"多数情况下是正常的处理流程特征，而非真正的错误。通过优化错误处理和用户提示，我们让用户能够：

1. ✅ 理解这是正常的等待过程
2. ✅ 知道应该等待多久
3. ✅ 获得明确的操作指导
4. ✅ 区分临时错误和永久失败

关键是**耐心等待**和**定期刷新**，大多数任务都会在几分钟内成功完成。

