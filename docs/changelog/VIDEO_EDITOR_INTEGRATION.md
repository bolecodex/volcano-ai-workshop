# 视频指令编辑功能集成

## 概述

成功集成了火山引擎的视频指令编辑 API，通过文本指令智能编辑视频内容。

**集成日期**: 2025-10-18  
**API 版本**: dm_seedance_videoedit_tob  
**req_key**: `dm_seedance_videoedit_tob`

## 功能特性

### 核心能力

- **智能编辑**: 通过自然语言文本指令编辑视频
- **元素操作**: 支持画面元素的替换、新增和删除
- **风格转换**: 可以将视频转换为不同的艺术风格（如新海诚风格）
- **精准控制**: 支持局部编辑和精准描述

### 技术参数

#### 输入限制
- 视频文件大小：≤ 15MB（推荐）
- 视频格式：建议 MP4
- 分辨率：≤ 1080P
- 帧率：≤ 30 FPS
- 时长：强烈建议 ≤ 10 秒
- URL：需要公网可访问

#### 输出规格
- 分辨率：固定 720P
- 帧率：固定 24 FPS
- 时长：最长 10 秒（由输入时长和 max_frame 共同决定）

#### 参数配置
- **prompt** (必填): 编辑指令文本
  - 建议长度 ≤ 120 字符
  - 使用自然语言即可
  - 单指令效果更好
  - 局部编辑时描述需精准
  
- **video_url** (必填): 视频 URL
  - 支持本地上传（自动上传到 TOS）
  - 支持手动输入公网 URL
  
- **seed** (可选): 随机种子
  - 默认值：-1（随机）
  - 相同种子可复现结果
  
- **max_frame** (可选): 输出视频最大帧数
  - 默认值：121（约 5 秒）
  - 可选范围：49-241（约 2-10 秒）
  - 可选值：49、73、97、121、145、169、193、217、241

## 实现细节

### 文件结构

```
api-service.js           # 新增视频编辑 API 方法
  - submitVideoEditTask()      # 提交视频编辑任务
  - queryVideoEditTask()       # 查询任务结果

desktop-app.js           # 新增 IPC 处理器
  - submit-video-edit-task     # 提交任务 IPC
  - query-video-edit-task      # 查询任务 IPC

public/preload.js        # 暴露 API 到前端
  - submitVideoEditTask()
  - queryVideoEditTask()

src/components/VideoEditor.js  # 视频编辑 React 组件
  - 文件上传和 TOS 集成
  - 表单输入和参数配置
  - 任务提交和状态查询
  - 任务历史管理
  - 结果展示

src/utils/storage.js     # 新增存储方法
  - setVideoEditHistory()
  - getVideoEditHistory()
  - clearVideoEditHistory()

src/App.js               # 添加路由
  - case 'video-editor'

src/components/Sidebar.js  # 添加菜单
  - { id: 'video-editor', label: '视频编辑', icon: 'bi-film' }
```

### API 接口

#### 提交任务

**接口地址**: `https://visual.volcengineapi.com?Action=CVSync2AsyncSubmitTask&Version=2022-08-31`

**请求方法**: POST

**请求体示例**:
```json
{
  "req_key": "dm_seedance_videoedit_tob",
  "prompt": "将此视频变成新海诚风格",
  "video_url": "https://example.com/video.mp4",
  "seed": -1,
  "max_frame": 121
}
```

**返回示例**:
```json
{
  "code": 10000,
  "data": {
    "task_id": "7392616336519610409"
  },
  "message": "Success",
  "request_id": "20240720103939AF0029465CF6A74E51EC",
  "status": 10000,
  "time_elapsed": "104.852309ms"
}
```

#### 查询任务

**接口地址**: `https://visual.volcengineapi.com?Action=CVSync2AsyncGetResult&Version=2022-08-31`

**请求方法**: POST

**请求体示例**:
```json
{
  "req_key": "dm_seedance_videoedit_tob",
  "task_id": "7392616336519610409"
}
```

**返回示例**:
```json
{
  "code": 10000,
  "data": {
    "aigc_meta_tagged": true,
    "status": "done",
    "video_url": "https://xxxx"
  },
  "message": "Success",
  "request_id": "20250728160702BE60872404A5149B0F60",
  "status": 10000,
  "time_elapsed": "537.736392ms"
}
```

### 任务状态

- **in_queue**: 任务已提交，排队中
- **generating**: 任务已被消费，处理中
- **done**: 处理完成（成功或失败，根据 code 和 message 判断）
- **not_found**: 任务未找到（无此任务或任务已过期）
- **expired**: 任务已过期（建议重新提交）

## UI 功能

### 左侧面板 - 编辑配置

1. **视频上传区域**
   - 支持本地视频文件上传
   - 自动上传到 TOS 并生成 URL
   - 显示上传进度
   - 文件大小和格式验证

2. **视频 URL 输入**
   - 上传后自动填充
   - 也可手动输入公网 URL

3. **编辑指令输入**
   - 多行文本框
   - 支持自然语言描述
   - 提供使用提示

4. **高级参数配置**
   - 随机种子设置
   - 输出视频最大帧数选择（下拉菜单）

5. **提交按钮**
   - 验证必填字段
   - 显示加载状态
   - 提交成功后清空表单

### 右侧面板 - 任务历史

1. **任务列表**
   - 显示最近 20 条任务
   - 任务状态标识（不同颜色徽章）
   - 创建时间
   - 快速操作按钮

2. **任务详情模态框**
   - 完整任务信息
   - 输入参数展示
   - 原视频链接
   - 结果视频播放器（任务完成后）
   - 视频下载按钮
   - 刷新状态按钮（处理中任务）

### 使用说明卡片

- 功能介绍
- 输入要求
- 使用建议
- 注意事项

## 使用示例

### 示例 1: 风格转换

```javascript
{
  "prompt": "将此视频变成新海诚风格",
  "video_url": "https://example.com/original.mp4",
  "seed": -1,
  "max_frame": 121
}
```

### 示例 2: 元素替换

```javascript
{
  "prompt": "将视频中的人物服装改为红色连衣裙",
  "video_url": "https://example.com/person.mp4",
  "seed": 12345,
  "max_frame": 145
}
```

### 示例 3: 场景修改

```javascript
{
  "prompt": "将视频背景从室内改为海滩场景",
  "video_url": "https://example.com/indoor.mp4",
  "seed": -1,
  "max_frame": 97
}
```

## 最佳实践

### 输入建议

1. **视频质量**
   - 尽量使用高质量的源视频
   - 保持适当的分辨率（不超过 1080P）
   - 控制文件大小在 15MB 以内

2. **编辑指令**
   - 使用清晰、具体的描述
   - 单次编辑使用单一指令效果更好
   - 局部编辑时要精准描述目标对象
   - 避免过长的指令（≤120 字符）

3. **参数设置**
   - 首次尝试使用默认参数
   - 需要复现效果时设置固定种子
   - 根据实际需求调整输出时长

### 错误处理

1. **上传失败**
   - 检查文件大小和格式
   - 确认 TOS 配置正确
   - 验证网络连接

2. **任务失败**
   - 检查视频 URL 是否可访问
   - 简化编辑指令
   - 减小视频文件大小或时长
   - 查看错误消息获取详细信息

3. **结果不理想**
   - 优化编辑指令描述
   - 尝试不同的种子值
   - 调整输入视频质量
   - 简化编辑要求

## 限制和注意事项

1. **输入限制**
   - 超过 15MB 的视频文件可能导致异常
   - 超过 10 秒的视频建议先剪辑
   - 视频 URL 必须公网可访问

2. **输出限制**
   - 输出固定为 720P、24 FPS
   - 最长输出 10 秒
   - 输出时长由输入和 max_frame 共同决定

3. **计费说明**
   - 按生成视频时长计费
   - 单价：0.65 元/秒
   - 免费额度：200 秒
   - 并发限额：1

4. **任务过期**
   - 任务结果保存 12 小时
   - 过期后需要重新提交
   - 建议及时下载结果视频

## 技术亮点

1. **完整的文件上传流程**
   - 本地文件选择
   - TOS 自动上传
   - URL 自动填充
   - 进度显示

2. **任务状态管理**
   - 实时状态查询
   - 自动状态更新
   - 历史记录保存
   - 本地持久化

3. **用户体验优化**
   - 直观的 UI 设计
   - 实时反馈和提示
   - 错误处理和指导
   - 结果预览和下载

4. **参数化配置**
   - 灵活的参数设置
   - 合理的默认值
   - 下拉选择和提示
   - 参数验证

## 后续优化方向

1. **功能增强**
   - 支持批量视频编辑
   - 添加预设编辑模板
   - 支持编辑历史记录导出
   - 添加视频预览功能

2. **性能优化**
   - 大文件分片上传
   - 上传进度优化
   - 任务状态轮询优化
   - 缓存优化

3. **用户体验**
   - 添加编辑效果示例
   - 提供编辑指令建议
   - 优化移动端适配
   - 增加快捷操作

4. **错误处理**
   - 更详细的错误提示
   - 自动重试机制
   - 失败原因分析
   - 解决方案建议

## 参考文档

- [视频指令编辑 API 文档](../api/视频指令编辑.md)
- [火山引擎视觉服务文档](https://www.volcengine.com/docs/6815/1285829)
- [签名机制说明](https://www.volcengine.com/docs/6815/1285838)

## 总结

视频指令编辑功能已成功集成到火山 AI 创作工坊中，为用户提供了强大的视频智能编辑能力。通过简单的文本指令，用户可以轻松实现视频内容的修改、风格转换和创意编辑，大大提升了视频创作的效率和灵活性。

